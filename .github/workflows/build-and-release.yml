name: Build and Release Netflix Rows Plugin

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        jellyfin-version: ['10.10.7']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      working-directory: ./Jellyfin.Plugin.NetflixRows
      run: dotnet restore --disable-parallel
    
    - name: Build
      working-directory: ./Jellyfin.Plugin.NetflixRows
      run: dotnet build --no-restore --configuration Release --verbosity normal
    
    - name: Test
      working-directory: ./Jellyfin.Plugin.NetflixRows
      run: dotnet test --no-build --verbosity normal --configuration Release || echo "No tests found, continuing..."
    
    - name: Create plugin archive
      run: |
        mkdir -p artifacts
        cd Jellyfin.Plugin.NetflixRows/bin/Release/net8.0
        zip -r ../../../../artifacts/jellyfin-plugin-netflix-rows-${{ github.ref_name || 'dev' }}.zip .
    
    - name: Generate manifest and repository files
      run: |
        # Generate timestamp
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.%fZ)
        # Extract version number without 'v' prefix
        RAW_VERSION="${{ github.ref_name || '1.0.0' }}"
        VERSION="${RAW_VERSION#v}"  # Remove 'v' prefix if present
        TAG_NAME="${{ github.ref_name || 'v1.0.0' }}"
        
        echo "Raw version: $RAW_VERSION"
        echo "Clean version: $VERSION" 
        echo "Tag name: $TAG_NAME"
        
        # Create manifest.json
        cat > artifacts/manifest.json << EOF
        [
          {
            "name": "Netflix Rows",
            "description": "Transform your Jellyfin home screen into a Netflix-like experience with dynamic rows, genres, and a custom watchlist.",
            "overview": "Netflix Rows Plugin f√ºr Jellyfin - Erstellt eine Netflix-√§hnliche Startseite mit dynamischen Rows, Genres und einer benutzerdefinierten Watchlist.",
            "owner": "${{ github.repository_owner }}",
            "category": "General",
            "guid": "12345678-1234-5678-9abc-123456789012",
            "versions": [
              {
                "version": "$VERSION",
                "changelog": "Netflix-style rows, genre filtering, and watchlist functionality. See GitHub releases for detailed changelog.",
                "targetAbi": "10.10.7.0",
                "sourceUrl": "https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/jellyfin-plugin-netflix-rows-$RAW_VERSION.zip",
                "checksum": "PLACEHOLDER_CHECKSUM",
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
        ]
        EOF
        
        # Create repository.json (copy from root or create new)
        if [ -f "repository.json" ]; then
          # Update existing repository.json
          cp repository.json artifacts/repository.json
          # Update the version info in the existing repository.json
          jq --arg version "$VERSION" \
             --arg checksum "PLACEHOLDER_CHECKSUM" \
             --arg sourceUrl "https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/jellyfin-plugin-netflix-rows-$RAW_VERSION.zip" \
             --arg timestamp "$TIMESTAMP" \
             --arg changelog "Netflix-style rows, genre filtering, and watchlist functionality. Full changelog: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME" \
             '.[0].versions = [{"version": $version, "changelog": $changelog, "targetAbi": "10.10.7.0", "sourceUrl": $sourceUrl, "checksum": $checksum, "timestamp": $timestamp}] + (.[0].versions // [])' \
             artifacts/repository.json > artifacts/repository_temp.json && mv artifacts/repository_temp.json artifacts/repository.json
        else
          # Create new repository.json if it doesn't exist
          cp artifacts/manifest.json artifacts/repository.json
        fi
        
        # Copy meta.json if it exists
        if [ -f "meta.json" ]; then
          cp meta.json artifacts/
        fi
    
    - name: Calculate and update checksums
      run: |
        # Calculate checksum of the zip file
        CHECKSUM=$(sha256sum artifacts/jellyfin-plugin-netflix-rows-*.zip | cut -d' ' -f1)
        echo "Calculated checksum: $CHECKSUM"
        
        # Update checksum in manifest.json
        sed -i "s/PLACEHOLDER_CHECKSUM/$CHECKSUM/g" artifacts/manifest.json
        
        # Update checksum in repository.json
        sed -i "s/PLACEHOLDER_CHECKSUM/$CHECKSUM/g" artifacts/repository.json
        
        # Verify the files contain the checksum
        echo "=== Manifest.json ==="
        cat artifacts/manifest.json
        echo "=== Repository.json ==="
        cat artifacts/repository.json
    
    - name: Create version-specific repository file
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Create a version-specific repository file for this release
        cp artifacts/repository.json artifacts/repository-${{ github.ref_name }}.json
        
        # Also update the main repository.json in the repo root (this will be committed later)
        cp artifacts/repository.json ./repository.json
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: plugin-artifacts-${{ matrix.jellyfin-version }}
        path: |
          artifacts/*.zip
          artifacts/manifest.json
          artifacts/repository.json
          artifacts/meta.json
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/*.zip
          artifacts/manifest.json
          artifacts/repository.json
          artifacts/repository-${{ github.ref_name }}.json
          artifacts/meta.json
        body: |
          ## Netflix Rows Plugin ${{ github.ref_name }}
          
          ### Features
          - üé¨ Netflix-style home screen with dynamic rows
          - üìö Genre-based content organization
          - ‚≠ê Custom "My List" functionality using favorites
          - üîÄ Random picks for content discovery
          - üìÖ Recently added and long not watched sections
          - ‚öôÔ∏è Comprehensive admin configuration
          - üé® Theme-adaptive design
          - üì± Responsive mobile support
          - ‚ö° Lazy loading for optimal performance
          
          ### Installation
          1. Add `https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/repository.json` as a plugin repository in Jellyfin
          2. Install "Netflix Rows" from the plugin catalog
          3. Restart Jellyfin
          4. Configure the plugin in the admin dashboard
          
          ### Requirements
          - Jellyfin 10.10.7 or later
          - File Transformation Plugin
          - Home Screen Sections Plugin (optional)
          - Plugin Pages Plugin (optional)
          
          ### Compatibility
          - Compatible with all Jellyfin themes
          - Supports dark/light theme switching
          - Mobile and desktop responsive
          - High contrast mode support
          - Reduced motion preferences
          
          Full documentation available in the repository README.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      working-directory: ./Jellyfin.Plugin.NetflixRows
      run: dotnet restore
    
    - name: Run tests
      working-directory: ./Jellyfin.Plugin.NetflixRows
      run: dotnet test --verbosity normal || echo "No tests found, continuing..."
    
    - name: Build
      working-directory: ./Jellyfin.Plugin.NetflixRows
      run: dotnet build --configuration Release